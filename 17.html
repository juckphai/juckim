<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>บัญชีรายรับรายจ่าย</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50"/>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="บัญชี">
  <link rel="apple-touch-icon" href="icon-192x192.png">

  <!-- ไลบรารีสำหรับอ่านไฟล์ CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <style>
    /* CSS ทั้งหมดของคุณยังคงเหมือนเดิม */
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #f4f7fb; margin: 0; padding: 0; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; text-size-adjust: 100%; }
    h2 { text-align: center; color: #333; margin-top: 30px; font-size: 28px; }
    .container { max-width: 800px; margin: 20px auto; background-color: #FAFAD2; border: 2px solid #ED01ED; padding: 10px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); width: 95%; }
    .section-header { background-color: #4CAF50; color: white; padding: 12px 15px; border-radius: 20px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .section-header:hover { background-color: #45a049; }
    .section-header .arrow { transition: transform 0.3s; }
    .section-header.active .arrow { transform: rotate(90deg); }
    .section-header > span:first-child { flex: 1; text-align: center; }
    .header-account, .header-add-data, .header-actions, .header-summary { border: 3px solid #E97132; }
    .header-account { background-color: #0070C0; }
    .header-account:hover { background-color: #B5E6A2; }
    .header-add-data { background-color: #00B0F0; }
    .header-add-data:hover { background-color: #B5E6A2; }
    .header-actions { background-color: #00B050; }
    .header-actions:hover { background-color: #B5E6A2; }
    .header-summary { background-color: #ED01ED; }
    .header-summary:hover { background-color: #B5E6A2; }
    .section-content { display: none; padding: 5px; border: 1px solid #ddd; border-radius: 20px; background-color: #f9f9f9; margin-bottom: 15px; }
    .section-content.active { display: block; }
    .sub-section-header { background-color: rgba(92, 107, 192, 0.6); margin-top: 20px; }
    .sub-section-header:hover { background-color: rgba(63, 81, 181, 0.75); }
    .sub-section-content { border: none; background-color: transparent; padding: 10px 0 0 0; margin-bottom: 0; }
    .entry-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .entry-group { display: flex; flex-direction: column; }
    .button-group, .button-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0; }
    label { font-weight: bold; color: #333; font-size: 16px; margin-bottom: 5px; text-align: center; }
    select, input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 20px; background-color: #f9f9f9; text-align: center; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .back-button, .file-button { font-size: 16px; padding: 12px 20px; border-radius: 20px; border: none; color: white; cursor: pointer; transition: background-color 0.3s, transform 0.2s; margin: 10px auto; display: block; width: 60%; max-width: 300px; }
    .back-button { background-color: #E97132; }
    .back-button:hover { background-color: #e64a19; }
    .file-button { background-color: #007bff; }
    .file-button:hover { background-color: #0056b3; }
    .button-group button, .button-container button { padding: 12px; font-size: 16px; border: none; border-radius: 50px; background-color: #4caf50; color: white; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; }
    .button-group button:hover, .button-container button:hover { background-color: #45a049; transform: translateY(-2px); }
    #recordTable { width: 100%; border-collapse: collapse; margin: 10px auto; }
    #recordTable th, #recordTable td { border: 1px solid #ccc; padding: 8px; line-height: 0.5; text-align: center; word-break: break-word; }
    #recordTable th { background-color: #f4f4f4; }
    #recordTable tr:nth-child(even) { background-color: #f9f9f9; }
    #recordTable tr:hover { background-color: #f1f1f1; }
    .summaryResult { font-size: clamp(12px, 2.2vw, 15px); font-weight: normal; color: blue; background-color: #FAFAD2; border: 3px solid #4CAF50; border-radius: 5px; padding: 5px; width: 100%; margin: 0; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.25); line-height: 0.5; }
    .summaryResult table td, .summaryResult table th { line-height: 0.5; }
    .file-actions { display: flex; gap: 10px; align-items: center; }
    .action-button { padding: 10px 20px; height: 40px; min-width: 150px; border: none; border-radius: 20px; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .file-button-wrapper button { background-color: #007bff; }
    .excel-button { background-color: #28a745; }
    .toast-notification { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; color: white; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s, transform 0.5s; transform: translateY(20px); }
    .toast-notification.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .checkbox-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; background-color: #e9ecef; padding: 10px; border-radius: 20px; border: 1px solid #ced4da; }
    .checkbox-item { display: flex; align-items: center; gap: 5px; justify-content: center; }
    .checkbox-item input { width: auto; }
    .summary-subsection { border-top: 1px solid #ccc; margin-top: 15px; padding-top: 15px; }
    .summary-subsection:first-child { border-top: none; margin-top: 0; padding-top: 0; }
    .summary-subsection-header { display: block; margin-bottom: 10px; font-weight: bold; font-size: 1.1em; color: #0056b3; }
    .modal-overlay { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; padding: 5px; overflow-y: auto; }
    .modal-content-container { background-color: transparent; padding: 0; border: none; box-shadow: none; display: flex; flex-direction: column; align-items: center; margin: auto 0; width: 100%; max-width: 800px; }
    .modal-close-btn { background-color: #E97132; color: white; padding: 12px 30px; border: none; cursor: pointer; border-radius: 20px; font-size: 16px; margin-top: 10px; transition: background-color 0.3s; }
    .modal-close-btn:hover { background-color: #e64a19; }
    .install-prompt { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 10px; padding: 15px; margin: 15px 10px; text-align: left; font-size: 14px; position: relative; }
    .install-prompt h4 { margin-top: 0; }
    .install-prompt ul { padding-left: 20px; margin-bottom: 0; }
    .install-prompt .close-prompt { position: absolute; top: 10px; right: 15px; font-size: 20px; font-weight: bold; cursor: pointer; color: #856404; }
    
    .format-modal-content {
      background-color: #fff;
      padding: 20px 30px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 400px;
    }
    .format-modal-content h3 {
      margin-top: 0;
      color: #333;
    }
    .format-modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    .format-modal-buttons button {
      padding: 15px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .format-modal-buttons .btn-json { background-color: #9C27B0; }
    .format-modal-buttons .btn-json:hover { background-color: #7B1FA2; }
    .format-modal-buttons .btn-csv { background-color: #2E7D32; }
    .format-modal-buttons .btn-csv:hover { background-color: #1B5E20; }
    .format-modal-buttons .btn-cancel { background-color: #6c757d; margin-top: 10px;}
    .format-modal-buttons .btn-cancel:hover { background-color: #5a6268; }

    .format-modal-buttons .btn-display { background-color: #007bff; }
    .format-modal-buttons .btn-display:hover { background-color: #0056b3; }


    @media screen and (max-width: 600px) { .container { padding: 5px; } h2 { font-size: 24px; } .entry-form, .button-group, .button-container { grid-template-columns: 1fr; } .sub-section-content .button-group { grid-template-columns: repeat(3, 1fr); gap: 5px; } .sub-section-content .button-group button { padding: 10px 5px; font-size: 14px; } .button-group button, .button-container button { padding: 14px; font-size: 16px; } .file-actions { flex-direction: column; padding: 0 10px; align-items: stretch; } .file-actions button { width: 100%; max-width: none; } .back-button { width: 100%; } }
  </style>
</head>
<body>
<div class="container" style="padding:0; border:none; background:none;">
    <div id="install-guide" class="install-prompt">
        <span class="close-prompt" onclick="this.parentElement.style.display='none'">&times;</span>
        <h4>ติดตั้งแอปนี้ลงในเครื่องของคุณ!</h4>
        <ul>
            <li><b>สำหรับ Android:</b> เบราว์เซอร์ Chrome จะมีปุ่ม "ติดตั้งแอป" หรือ "เพิ่มไปยังหน้าจอหลัก" แสดงขึ้นมาให้กด</li>
            <li><b>สำหรับ iPhone (iOS):</b> เปิดใน Safari แล้วกดที่ปุ่ม "แชร์" (Share) จากนั้นเลือก "เพิ่มไปยังหน้าจอโฮม" (Add to Home Screen)</li>
        </ul>
        <p style="color: red; font-weight: bold; margin-top: 10px; margin-bottom: 0;">
            ข้อควรระวังสำหรับ iPhone: ระบบอาจลบข้อมูลที่บันทึกไว้หากไม่ได้ใช้งานนานๆ หรือพื้นที่เหลือน้อย! <br>แนะนำให้ "บันทึกถาวร" หรือ "ส่งออกบัญชีที่เลือก" เพื่อสำรองข้อมูลสม่ำเสมอ
        </p>
    </div>
</div>

<div style="text-align: center; margin-top: 5px;">
    <div class="container">
        <!-- เนื้อหา HTML หลักทั้งหมดของคุณ -->
        <!-- ... -->
        <div style="width: 100%; max-width: 600px; margin: 10px auto;">
            <div class="file-actions" style="display: flex; justify-content: center; gap: 10px;">
              <div class="file-button-wrapper" style="flex: 1; min-width: 0;">
                <input type="file" id="fileInput" onchange="loadFromFile(event)" style="display: none;" accept=".json,application/json,.csv,text/csv">
                <button type="button" onclick="document.getElementById('fileInput').click()" 
                        class="action-button" 
                         style="width: 100%; height: 45px; padding: 10px; font-size: 16px; background-color: #196B24; color: #FFFFFF; border: 2px solid #EE0000; border-radius: 30px; cursor: pointer; margin: 0 auto;">
                  โหลดข้อมูลบัญชี
                </button>
        </div>
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <h1 style="text-align: center; color: blue; font-size: 16px;">
            ชื่อบัญชี - <span id="accountName"></span>
          </h1>
          <div class="section-header header-account" onclick="toggleSection('account-section')">
            <span>เลือกและจัดการบัญชี</span>
            <span class="arrow">▶</span>
          </div>
          <div id="account-section" class="section-content">
            <label for="accountSelect">เลือกบัญชี:</label>
            <select id="accountSelect" onchange="changeAccount()"></select>
            
            <div class="section-header sub-section-header" onclick="toggleSection('manage-account-submenu')">
              <span>จัดการบัญชี</span>
              <span class="arrow">▶</span>
            </div>
            <div id="manage-account-submenu" class="section-content sub-section-content">
              <div class="button-group">
                <button type="button" onclick="addAccount()" style="background-color: #28a745;">เพิ่มบช.ใหม่</button>
                <button type="button" onclick="deleteAccount()" style="background-color: #dc3545;">ลบบช.</button>
                <button type="button" onclick="editAccount()" style="background-color: #ffc107;">แก้ไขชื่อบช.</button>
              </div>
            </div>
          </div>
        
          <div class="section-header header-add-data" onclick="toggleSection('add-data-section')">
            <span>เพิ่มข้อมูล</span>
            <span class="arrow">▶</span>
          </div>
          <div id="add-data-section" class="section-content">
            <div class="entry-form">
              <div class="entry-group">
                <label for="entryDate">วันที่ (วัน/เดือน/ปี)</label>
                <input type="text" id="entryDate" placeholder="เช่น 10/11/2024">
              </div>
              <div class="entry-group">
                <label for="entryTime">เวลา (HH.MM)</label>
                <input type="text" id="entryTime" placeholder="เช่น 14.30" pattern="\d{1,2}\.\d{2}">
              </div>
            </div>
            <div class="entry-group">
              <label for="amount">จำนวนเงิน</label>
              <input type="number" id="amount" required>
            </div>
            <div class="entry-group">
              <label for="type">ประเภท</label>
              <input list="typeList" id="type" required placeholder="เลือกหรือพิมพ์ประเภท" style="height: 40px;" onfocus="showAllTypes(this)" onblur="restoreType(this)">
              <datalist id="typeList"></datalist>
              
              <div class="section-header sub-section-header" onclick="toggleSection('manage-types-submenu')" style="margin-top:10px;">
                <span>จัดการประเภท</span>
                <span class="arrow">▶</span>
              </div>
              <div id="manage-types-submenu" class="section-content sub-section-content">
                <div class="button-group">
                  <button type="button" onclick="addNewType()" style="background-color: #2196F3;">เพิ่มประเภท</button>
                  <button type="button" onclick="deleteType()" style="background-color: #F44336;">ลบประเภท</button>
                  <button type="button" onclick="editType()" style="background-color: #FFC107;">แก้ไขประเภท</button>
                </div>
              </div>
            </div>
            <div class="entry-group">
              <label for="description">รายละเอียด</label>
              <input type="text" id="description" required>
            </div>
            
            <div class="entry-group" id="multiAccountSelector" style="display: none; margin-top: 10px;">
                <div class="section-header sub-section-header" onclick="toggleSection('multi-account-submenu')">
                    <span>เพิ่มรายการนี้ในบัญชีอื่นด้วย</span>
                    <span class="arrow">▶</span>
                </div>
                <div id="multi-account-submenu" class="section-content sub-section-content">
                    <div id="multiAccountCheckboxes" class="checkbox-container">
                    </div>
                </div>
            </div>
        
            <div class="button-container" style="text-align: center; margin-top: 20px;">
              <button type="button" onclick="addEntry()" style="background-color: #e91e63;">เพิ่มข้อมูล</button>
            </div>
          </div>
          
          <div class="section-header header-actions" onclick="toggleSection('other-actions-section')">
            <span>จัดการข้อมูล</span>
            <span class="arrow">▶</span>
          </div>
          <div id="other-actions-section" class="section-content">
            <div class="button-container" style="display: flex; gap: 10px; margin-top: 10px;">
              <button onclick="toggleRecordsVisibility()" style="flex: 1; background-color: #607d8b;">แสดง/ซ่อนรายการ</button>
            </div>
            <div class="button-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
              <button type="button" onclick="saveToFile()" style="flex: 1; background-color: #0d47a1;">บันทึกถาวรทุกบัญชี</button>
              <button type="button" onclick="saveToLocal()" style="flex: 1; background-color: #17a2b8;">บันทึกชั่วคราว</button>
              <button type="button" onclick="exportSelectedAccount()" style="flex: 1; background-color: #ff9800; color: white;">ส่งออกบัญชีที่เลือก</button>
            </div>
          </div>
        
          <div class="section-header header-summary" onclick="toggleSection('summary-main-section')">
            <span>สรุปข้อมูล</span>
            <span class="arrow">▶</span>
          </div>
          <div id="summary-main-section" class="section-content">
            <div class="summary-subsection">
              <div class="button-container" style="margin: 0;">
                <button type="button" onclick="summarizeToday()" style="background-color: #ff9800; color: #FFFFFF;">สรุปวันนี้</button>
              </div>
            </div>
            <div class="summary-subsection">
              <div class="button-container" style="margin: 0;">
                <button type="button" onclick="summarizeAll()" style="background-color: #673ab7; color: #FFFFFF;">สรุปข้อมูลทั้งหมด</button>
              </div>
            </div>
            <div class="summary-subsection">
              <label class="summary-subsection-header">สรุปวันที่เลือก</label>
              <div class="entry-form" style="margin-bottom: 0;">
                <div class="entry-group">
                  <label for="customDayMonth">วันที่ (วัน/เดือน/ปี):</label>
                  <input type="text" id="customDayMonth" placeholder="เช่น 10/11/2024">
                </div>
              </div>
              <div class="button-container" style="text-align: center; margin-top: 10px;">
                <button type="button" onclick="summarizeByDayMonth()" style="background-color: #03a9f4;">สรุปวันที่เลือก</button>
              </div>
            </div>
            <div class="summary-subsection">
              <label class="summary-subsection-header">สรุปวันที่ถึงวันที่</label>
              <div class="entry-form" style="margin-bottom: 0;">
                <div class="entry-group">
                  <label for="startDate">จากวันที่ (วัน/เดือน/ปี):</label>
                  <input type="text" id="startDate" placeholder="เช่น 10/11/2024">
                </div>
                <div class="entry-group">
                  <label for="endDate">ถึงวันที่ (วัน/เดือน/ปี):</label>
                  <input type="text" id="endDate" placeholder="เช่น 15/11/2024">
                </div>
              </div>
              <div class="button-container" style="text-align: center; margin-top: 10px;">
                <button type="button" onclick="summarize()" style="background-color: #009688;">สรุปวันที่ถึงวันที่</button>
              </div>
            </div>
          </div>
        </div>
    </div>
        
    <div id="detailsSection" style="display: none; margin-top: 20px; width: 100%; overflow-x: auto;">
        <table id="recordTable" style="min-width: 600px;">
        <thead>
            <tr style="background-color: #f2f2f2;">
            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">วันเดือนปี</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">เวลา</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ประเภท</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">รายละเอียด</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">จำนวนเงิน</th>
            <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">การจัดการ</th>
            </tr>
        </thead>
        <tbody id="recordBody" style="font-size: 14px;"></tbody>
        </table>
    </div>
</div>

<!-- โครงสร้าง Popup สำหรับแสดงผลสรุป -->
<div id="summaryModal" class="modal-overlay">
  <div class="modal-content-container">
    <div id="modalBodyContent" class="summaryResult">
      <!-- เนื้อหาการสรุปจะถูกใส่ที่นี่โดย JavaScript -->
    </div>
    <button onclick="closeSummaryModal()" class="modal-close-btn">ปิดหน้าต่างนี้</button>
  </div>
</div>

<!-- Modal สำหรับเลือกรูปแบบไฟล์ (สำรองข้อมูลทั้งหมด) -->
<div id="formatSelectionModal" class="modal-overlay">
  <div class="format-modal-content">
    <h3>เลือกรูปแบบไฟล์สำรองข้อมูล</h3>
    <div class="format-modal-buttons">
      <button class="btn-json" onclick="handleSaveAs('json')">JSON (.json)</button>
      <button class="btn-csv" onclick="handleSaveAs('csv')">CSV (.csv)</button>
      <button class="btn-cancel" onclick="closeFormatModal()">ยกเลิก</button>
    </div>
  </div>
</div>

<!-- Modal สำหรับเลือกรูปแบบไฟล์ (บัญชีที่เลือก) -->
<div id="exportSingleAccountModal" class="modal-overlay">
  <div class="format-modal-content">
    <h3>เลือกรูปแบบไฟล์สำหรับบัญชีที่เลือก</h3>
    <div class="format-modal-buttons">
      <button class="btn-json" onclick="handleExportSelectedAs('json')">JSON (.json)</button>
      <button class="btn-csv" onclick="handleExportSelectedAs('csv')">CSV (.csv)</button>
      <button class="btn-cancel" onclick="closeExportSingleAccountModal()">ยกเลิก</button>
    </div>
  </div>
</div>

<!-- Modal สำหรับเลือกรูปแบบการแสดงผลสรุป -->
<div id="summaryOutputModal" class="modal-overlay">
    <div class="format-modal-content">
        <h3>เลือกรูปแบบการแสดงผลสรุป</h3>
        <div class="format-modal-buttons">
            <button class="btn-display" onclick="handleSummaryOutput('display')">แสดงบนจอ</button>
            <button class="btn-csv" onclick="handleSummaryOutput('csv')">ส่งออกเป็น CSV</button>
            <button class="btn-cancel" onclick="closeSummaryOutputModal()">ยกเลิก</button>
        </div>
    </div>
</div>


<div id="toast" class="toast-notification"></div>

<script>
    function openSummaryModal(htmlContent) { const modal = document.getElementById('summaryModal'); const modalBody = document.getElementById('modalBodyContent'); modalBody.innerHTML = htmlContent; modal.style.display = 'flex'; }
    function closeSummaryModal() { const modal = document.getElementById('summaryModal'); modal.style.display = 'none'; }
    function toggleSection(sectionId) { const section = document.getElementById(sectionId); const header = section.previousElementSibling; section.classList.toggle('active'); header.classList.toggle('active'); }
    let accounts = [];
    let currentAccount = null;
    let records = [];
    let editingIndex = null;
    let accountTypes = new Map();
    let tempTypeValue = '';
    
    let summaryContext = {};

    function showAllTypes(inputElement) { tempTypeValue = inputElement.value; inputElement.value = ''; }
    function restoreType(inputElement) { if (inputElement.value === '') { inputElement.value = tempTypeValue; } }
    function updateMultiAccountSelector() { const selectorDiv = document.getElementById('multiAccountSelector'); const checkboxesDiv = document.getElementById('multiAccountCheckboxes'); checkboxesDiv.innerHTML = ''; if (accounts.length > 1 && editingIndex === null) { selectorDiv.style.display = 'block'; accounts.forEach(acc => { if (acc !== currentAccount) { const itemDiv = document.createElement('div'); itemDiv.className = 'checkbox-item'; const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = `acc-check-${acc}`; checkbox.value = acc; const label = document.createElement('label'); label.htmlFor = `acc-check-${acc}`; label.textContent = acc; itemDiv.appendChild(checkbox); itemDiv.appendChild(label); checkboxesDiv.appendChild(itemDiv); } }); } else { selectorDiv.style.display = 'none'; } }
    function initializeAccountTypes(accountName) { if (!accountTypes.has(accountName)) { accountTypes.set(accountName, { "รายรับ": ["ถูกหวย", "เติมทุน"], "รายจ่าย": ["ชื้อหวย", "โอนกำไร", "ชื้อกับข้าว"] }); } }
    function updateTypeList() { const typeList = document.getElementById('typeList'); if (!currentAccount) { typeList.innerHTML = ''; return; } initializeAccountTypes(currentAccount); const types = accountTypes.get(currentAccount); typeList.innerHTML = ''; types["รายจ่าย"].forEach(type => { const option = document.createElement('option'); option.value = type; typeList.appendChild(option); }); types["รายรับ"].forEach(type => { const option = document.createElement('option'); option.value = type; typeList.appendChild(option); }); }
    function addNewType() { if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนเพิ่มประเภท"); return; } initializeAccountTypes(currentAccount); const types = accountTypes.get(currentAccount); const category = prompt("เลือกประเภทที่จะเพิ่ม (รายรับ/รายจ่าย):"); if (category !== "รายรับ" && category !== "รายจ่าย") { alert("กรุณากรอก 'รายรับ' หรือ 'รายจ่าย' เท่านั้น"); return; } const typeInput = document.getElementById('type'); const typeName = typeInput.value.trim(); if (!typeName) { alert("กรุณากรอกชื่อประเภทในช่องประเภทก่อน"); return; } if (!types[category].includes(typeName)) { types[category].push(typeName); updateTypeList(); alert(`เพิ่มประเภท "${typeName}" ในหมวด "${category}" เรียบร้อย`); saveToLocal(); } else { alert("ประเภทนี้มีอยู่แล้ว"); } }
    function editType() { if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนแก้ไขประเภท"); return; } initializeAccountTypes(currentAccount); const types = accountTypes.get(currentAccount); const typeInput = document.getElementById('type'); const currentType = typeInput.value.trim(); if (!currentType) { alert("กรุณาเลือกหรือพิมพ์ประเภทที่ต้องการแก้ไข"); return; } let foundCategory = null; for (const category in types) { if (types[category].includes(currentType)) { foundCategory = category; break; } } if (!foundCategory) { alert("ไม่พบประเภทที่ต้องการแก้ไข"); return; } const newName = prompt("กรุณากรอกชื่อประเภทใหม่:", currentType); if (newName && newName !== currentType) { const index = types[foundCategory].indexOf(currentType); types[foundCategory][index] = newName; records.forEach(record => { if (record.account === currentAccount && record.type === currentType) { record.type = newName; } }); updateTypeList(); typeInput.value = newName; alert("แก้ไขชื่อประเภทเรียบร้อย"); saveToLocal(); } }
    function deleteType() { if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนลบประเภท"); return; } initializeAccountTypes(currentAccount); const types = accountTypes.get(currentAccount); const typeInput = document.getElementById('type'); const currentType = typeInput.value.trim(); if (!currentType) { alert("กรุณาเลือกหรือพิมพ์ประเภทที่ต้องการลบ"); return; } let foundCategory = null; for (const category in types) { if (types[category].includes(currentType)) { foundCategory = category; break; } } if (!foundCategory) { alert("ไม่พบประเภทที่ต้องการลบ"); return; } if (confirm(`คุณแน่ใจว่าจะลบประเภท "${currentType}" หรือไม่?`)) { const index = types[foundCategory].indexOf(currentType); types[foundCategory].splice(index, 1); updateTypeList(); typeInput.value = ''; alert("ลบประเภทเรียบร้อย"); saveToLocal(); } }
    function toggleRecordsVisibility() { const detailsSection = document.getElementById('detailsSection'); if (detailsSection.style.display === 'none' || detailsSection.style.display === '') { detailsSection.style.display = 'block'; } else { detailsSection.style.display = 'none'; } }
    function addAccount() { const accountName = prompt("กรุณากรอกชื่อบัญชีใหม่:"); if (accountName && !accounts.includes(accountName)) { accounts.push(accountName); updateAccountSelect(); updateMultiAccountSelector(); alert("เพิ่มบัญชีสำเร็จ"); saveToLocal(); } else { alert("ชื่อบัญชีซ้ำหรือกรอกข้อมูลไม่ถูกต้อง"); } }
    function updateAccountSelect() { const accountSelect = document.getElementById('accountSelect'); accountSelect.innerHTML = '<option value="">เลือกบัญชี</option>'; accounts.forEach(account => { const option = document.createElement('option'); option.value = account; option.textContent = account; accountSelect.appendChild(option); }); }
    function changeAccount() { currentAccount = document.getElementById('accountSelect').value; document.getElementById('accountName').textContent = currentAccount || ""; updateTypeList(); displayRecords(); updateMultiAccountSelector(); }
    function editAccount() { if (!currentAccount) { alert("กรุณาเลือกบัญชีที่ต้องการแก้ไข"); return; } const newAccountName = prompt("กรุณากรอกชื่อบัญชีใหม่:", currentAccount); if (newAccountName && newAccountName !== currentAccount && !accounts.includes(newAccountName)) { const oldAccountName = currentAccount; const index = accounts.indexOf(oldAccountName); if (index > -1) { accounts[index] = newAccountName; records.forEach(record => { if (record.account === oldAccountName) { record.account = newAccountName; } }); if (accountTypes.has(oldAccountName)) { const oldTypes = accountTypes.get(oldAccountName); accountTypes.set(newAccountName, oldTypes); accountTypes.delete(oldAccountName); } currentAccount = newAccountName; updateAccountSelect(); document.getElementById('accountSelect').value = newAccountName; document.getElementById('accountName').textContent = currentAccount; displayRecords(); updateMultiAccountSelector(); alert("แก้ไขชื่อบัญชีเรียบร้อย"); saveToLocal(); } } else { alert("ชื่อบัญชีซ้ำหรือกรอกข้อมูลไม่ถูกต้อง"); } }
    function deleteAccount() { if (currentAccount) { const confirmDelete = confirm(`คุณแน่ใจว่าจะลบบัญชี "${currentAccount}" และข้อมูลทั้งหมดในบัญชีนี้หรือไม่?`); if (confirmDelete) { const accountToDelete = currentAccount; const index = accounts.indexOf(accountToDelete); if (index > -1) { accounts.splice(index, 1); } accountTypes.delete(accountToDelete); records = records.filter(rec => rec.account !== accountToDelete); currentAccount = null; document.getElementById('accountSelect').value = ""; document.getElementById('accountName').textContent = ""; updateAccountSelect(); displayRecords(); updateMultiAccountSelector(); alert("ลบบัญชีเรียบร้อย"); saveToLocal(); } } else { alert("กรุณาเลือกบัญชีที่ต้องการลบ"); } }
    function addEntry() { let entryDateInput = document.getElementById('entryDate').value.trim(); let entryTimeInput = document.getElementById('entryTime').value.trim(); const typeInput = document.getElementById('type'); const typeText = typeInput.value.trim(); const description = document.getElementById('description').value; const amount = parseFloat(document.getElementById('amount').value); let selectedDate; if (!entryDateInput) { selectedDate = new Date(); } else { if (!/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(entryDateInput)) { alert("กรุณากรอกวัน/เดือน/ปี ในรูปแบบ วัน/เดือน/ปี (เช่น 10/11/2024)"); return; } const [day, month, year] = entryDateInput.split('/'); selectedDate = new Date(year, month - 1, day); } let hours, minutes; if (!entryTimeInput) { const now = new Date(); hours = String(now.getHours()).padStart(2, '0'); minutes = String(now.getMinutes()).padStart(2, '0'); } else { if (!/^\d{1,2}\.\d{2}$/.test(entryTimeInput)) { alert("กรุณากรอกเวลาในรูปแบบ HH.MM (เช่น 14.30)"); return; } [hours, minutes] = entryTimeInput.split('.'); hours = String(hours).padStart(2, '0'); minutes = String(minutes).padStart(2, '0'); } const timeString = `${hours}:${minutes}`; const formattedDate = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`; const dateTime = `${formattedDate} ${timeString}`; if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนเพิ่มรายการ"); return; } if (!typeText) { alert("กรุณากรอกประเภท"); return; } if (!description) { alert("กรุณากรอกรายละเอียด"); return; } if (isNaN(amount) || amount <= 0) { alert("กรุณากรอกจำนวนเงินที่ถูกต้อง"); return; } initializeAccountTypes(currentAccount); const types = accountTypes.get(currentAccount); let entryCategory = 'expense'; if (types["รายรับ"].includes(typeText)) { entryCategory = 'income'; } if (editingIndex !== null) { records[editingIndex] = { dateTime, type: typeText, description, amount, account: currentAccount }; editingIndex = null; } else { records.push({ dateTime, type: typeText, description, amount, account: currentAccount }); const selectedCheckboxes = document.querySelectorAll('#multiAccountCheckboxes input:checked'); selectedCheckboxes.forEach(checkbox => { const targetAccount = checkbox.value; records.push({ dateTime, type: typeText, description, amount, account: targetAccount }); }); } displayRecords(); document.getElementById('description').value = ''; document.getElementById('amount').value = ''; document.getElementById('entryDate').value = ''; document.getElementById('entryTime').value = ''; typeInput.value = ''; document.querySelectorAll('#multiAccountCheckboxes input:checked').forEach(checkbox => { checkbox.checked = false; }); saveDataAndShowToast(entryCategory); updateMultiAccountSelector(); }
    function saveDataAndShowToast(entryCategory = 'neutral') { const dataToSave = { accounts: [...accounts], currentAccount: currentAccount, records: [...records], accountTypes: Array.from(accountTypes.entries()) }; try { localStorage.setItem('accountData', JSON.stringify(dataToSave)); } catch (error) { console.error("บันทึกข้อมูลไม่สำเร็จ:", error); alert("⚠️ เกิดข้อผิดพลาดในการบันทึกข้อมูล"); return; } const toast = document.getElementById('toast'); toast.textContent = '✓ บันทึกข้อมูลสำเร็จแล้ว'; if (entryCategory === 'income') { toast.style.backgroundColor = '#28a745'; } else if (entryCategory === 'expense') { toast.style.backgroundColor = '#dc3545'; } else { toast.style.backgroundColor = '#007bff'; } toast.className = "toast-notification show"; setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 2500); }
    function displayRecords() { const recordBody = document.getElementById('recordBody'); recordBody.innerHTML = ""; const filteredRecords = records.filter(record => record.account === currentAccount) .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)); filteredRecords.forEach((record, index) => { const originalIndex = records.findIndex(r => r === record); const dateTime = new Date(record.dateTime); const formattedDate = `${String(dateTime.getDate()).padStart(2, '0')}/${String(dateTime.getMonth() + 1).padStart(2, '0')}/${dateTime.getFullYear()}`; const formattedTime = `${String(dateTime.getHours()).padStart(2, '0')}.${String(dateTime.getMinutes()).padStart(2, '0')} น.`; const row = document.createElement('tr'); row.innerHTML = ` <td>${formattedDate}</td> <td>${formattedTime}</td> <td>${record.type}</td> <td>${record.description}</td> <td>${record.amount.toLocaleString()} บาท</td> <td> <button onclick="editRecord(${originalIndex})">แก้ไข</button> <button onclick="deleteRecord(${originalIndex})">ลบ</button> </td> `; recordBody.appendChild(row); }); if (filteredRecords.length === 0) { const row = document.createElement('tr'); row.innerHTML = `<td colspan="6" style="text-align: center;">ไม่มีข้อมูล</td>`; recordBody.appendChild(row); } }
    function editRecord(index) { const record = records[index]; document.getElementById('type').value = record.type; document.getElementById('description').value = record.description; document.getElementById('amount').value = record.amount; const [datePart, timePart] = record.dateTime.split(' '); const [year, month, day] = datePart.split('-'); document.getElementById('entryDate').value = `${day}/${month}/${year}`; const [hours, minutes] = timePart.split(':'); document.getElementById('entryTime').value = `${hours}.${minutes}`; editingIndex = index; updateMultiAccountSelector(); }
    function deleteRecord(index) { if (confirm("คุณแน่ใจว่าจะลบรายการนี้หรือไม่?")) { records.splice(index, 1); displayRecords(); saveDataAndShowToast(); } }
    function parseDateInput(dateStr) { if (!dateStr || !/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) { return null; } const [day, month, year] = dateStr.split('/'); return new Date(year, month - 1, day); }

    // --- Modal Controls for Summary Output ---
    function openSummaryOutputModal() { document.getElementById('summaryOutputModal').style.display = 'flex'; }
    function closeSummaryOutputModal() { document.getElementById('summaryOutputModal').style.display = 'none'; summaryContext = {}; }
    
    function handleSummaryOutput(choice) {
        if (!summaryContext || !summaryContext.summaryResult) {
            console.error("Summary context is missing. Cannot proceed.");
            closeSummaryOutputModal();
            return;
        }
        const { summaryResult, title, dateString, remark, transactionDaysInfo, periodName, showDetailsOnDisplay } = summaryContext;
        
        if (choice === 'display') {
            // Pass the new flag to the HTML builder function
            const html = buildSummaryHtml(summaryResult, title, dateString, remark, transactionDaysInfo, showDetailsOnDisplay);
            openSummaryModal(html);
        } else if (choice === 'csv') {
            exportSummaryToCsv(summaryResult, title, dateString, remark, transactionDaysInfo, periodName);
        }
        closeSummaryOutputModal(); // Close and clear context after action
    }

    // --- Core Summary Logic ---
    function generateSummaryData(startDate, endDate) {
        if (!currentAccount || !accountTypes.has(currentAccount)) { alert("ไม่พบบัญชีหรือประเภทของบัญชี"); return null; }
        const summary = { income: {}, expense: {}, totalIncome: 0, totalExpense: 0, incomeCount: 0, expenseCount: 0 };
        const periodRecords = []; let totalBalance = 0; const accountSpecificTypes = accountTypes.get(currentAccount);
        records.forEach(record => {
            if (record.account !== currentAccount) return;
            const recordDate = new Date(record.dateTime);
            if (recordDate <= endDate) {
                if (accountSpecificTypes["รายรับ"].includes(record.type)) { totalBalance += record.amount; }
                else if (accountSpecificTypes["รายจ่าย"].includes(record.type)) { totalBalance -= record.amount; }
            }
            if (!(recordDate >= startDate && recordDate <= endDate)) return;
            periodRecords.push(record);
            if (accountSpecificTypes["รายรับ"].includes(record.type)) {
                summary.totalIncome += record.amount; summary.incomeCount++;
                if (!summary.income[record.type]) summary.income[record.type] = { amount: 0, count: 0 };
                summary.income[record.type].amount += record.amount; summary.income[record.type].count++;
            } else if (accountSpecificTypes["รายจ่าย"].includes(record.type)) {
                summary.totalExpense += record.amount; summary.expenseCount++;
                if (!summary.expense[record.type]) summary.expense[record.type] = { amount: 0, count: 0 };
                summary.expense[record.type].amount += record.amount; summary.expense[record.type].count++;
            }
        });
        periodRecords.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
        return { summary, periodRecords, totalBalance };
    }
    
    // [ปรับปรุง] ฟังก์ชันนี้จะตรวจสอบค่า `showDetails` ก่อนสร้างตาราง
    function buildSummaryHtml(summaryResult, title, dateString, remark, transactionDaysInfo = null, showDetails = true) {
        const { summary, periodRecords, totalBalance } = summaryResult;
        let transactionDaysSummary = '';
        if (transactionDaysInfo) {
            transactionDaysSummary = `<p style="font-size: 16px; color: blue; font-weight: bold;">${transactionDaysInfo.totalDaysText}</p><p style="font-size: 16px; color: #333; font-weight: bold;">${transactionDaysInfo.activityText}</p>`;
        }
        let incomeHTML = ''; for (const type in summary.income) { incomeHTML += `<p>- ${type} : ${summary.income[type].count} ครั้ง เป็นเงิน ${summary.income[type].amount.toLocaleString()} บาท</p>`; }
        let expenseHTML = ''; for (const type in summary.expense) { expenseHTML += `<p>- ${type} : ${summary.expense[type].count} ครั้ง เป็นเงิน ${summary.expense[type].amount.toLocaleString()} บาท</p>`; }
        
        let recordsHTML = '';
        // Only generate the details table if showDetails is true and there are records
        if (showDetails && periodRecords.length > 0) {
            recordsHTML = `<div style="margin-top: 20px;"><h4 style="border-bottom: 1px solid #ddd; padding-bottom: 5px;">รายละเอียด: ${title}</h4><table style="width: 100%; border-collapse: collapse; margin-top: 10px;"><thead><tr style="background-color: #f2f2f2;"><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">วันที่</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">เวลา</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ประเภท</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">รายละเอียด</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">จำนวนเงิน</th></tr></thead><tbody> ${periodRecords.map(record => {
                const d = new Date(record.dateTime);
                const date = d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const time = d.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }).replace(':', '.');
                const isIncome = accountTypes.get(currentAccount)["รายรับ"].includes(record.type); const color = isIncome ? "#4CAF50" : "#F44336";
                return `<tr><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${date}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${time}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.type}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.description}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${color}; font-weight: bold;">${record.amount.toLocaleString()}</td></tr>`;
            }).join('')} </tbody></table></div>`;
        }

        const summaryDateTime = new Date().toLocaleString("th-TH", { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) + ' น.';
        const netAmount = summary.totalIncome - summary.totalExpense; const netColor = netAmount >= 0 ? 'blue' : 'red';
        const netText = netAmount > 0 ? 'รายได้มากกว่ารายจ่าย' : (netAmount < 0 ? 'รายจ่ายมากกว่ารายได้' : 'รายได้เท่ากับรายจ่าย');
        let summaryLineHTML = `<p style="color: ${netColor}; font-weight: bold;">สรุป : ${netText} = ${Math.abs(netAmount).toLocaleString()} บาท</p>`;
        if(netAmount === 0 && summary.totalIncome === 0 && summary.totalExpense === 0){ summaryLineHTML = `<p style="color: green; font-weight: bold;">สรุป : ไม่มีรายการการเงินในช่วงนี้</p>`; }
        return `<p><strong>ชื่อบัญชี:</strong> ${currentAccount}</p><p><strong>สรุปเมื่อวันที่ : </strong> ${summaryDateTime}</p><p><strong>${title} : </strong> ${dateString}</p>${transactionDaysSummary}<hr><p><strong>รายรับ : </strong> ${summary.incomeCount} ครั้ง เป็นเงิน ${summary.totalIncome.toLocaleString()} บาท</p>${incomeHTML}<hr><p><strong>รายจ่าย : </strong> ${summary.expenseCount} ครั้ง เป็นเงิน ${summary.totalExpense.toLocaleString()} บาท</p>${expenseHTML}<hr>${summaryLineHTML}<p><span style="color: blue; font-size: 14px; font-weight: bold;">เงินในบัญชีถึงวันที่เลือกมี = </span><span style="color: ${totalBalance >= 0 ? 'green' : 'red'}; font-size: 16px; font-weight: bold;">${totalBalance.toLocaleString()}</span> บาท</p><p>ข้อความเพิ่ม : <span style="color: orange;">${remark}</span></p>${recordsHTML}`;
    }
    
    function exportSummaryToCsv(summaryResult, title, dateString, remark, transactionDaysInfo = null, periodName) {
        const { summary, periodRecords, totalBalance } = summaryResult; 
        let csvRows = [];
        const summaryDateTime = new Date().toLocaleString("th-TH", { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) + ' น.';
        
        // --- ส่วนหัว ---
        csvRows.push(['สรุปข้อมูลบัญชี']);
        csvRows.push(['ชื่อบัญชี:', currentAccount]); 
        csvRows.push(['สรุปเมื่อวันที่:', summaryDateTime]); 
        csvRows.push([`${title}:`, dateString]);
        if(transactionDaysInfo) {
            csvRows.push([transactionDaysInfo.totalDaysText]);
            csvRows.push([transactionDaysInfo.activityText]);
        }
        csvRows.push(['']); // เว้นบรรทัด

        // --- ส่วนรายรับ ---
        csvRows.push([`--- รายรับ: ${summary.incomeCount} ครั้ง | รวม ${summary.totalIncome.toLocaleString()} บาท ---`]);
        for (const type in summary.income) {
            const line = `  ${type}`; 
            csvRows.push([line, `${summary.income[type].count} ครั้ง`, `${summary.income[type].amount.toLocaleString()} บาท`]); 
        }
        csvRows.push(['']); // เว้นบรรทัด

        // --- ส่วนรายจ่าย ---
        csvRows.push([`--- รายจ่าย: ${summary.expenseCount} ครั้ง | รวม ${summary.totalExpense.toLocaleString()} บาท ---`]);
        for (const type in summary.expense) {
            const line = `  ${type}`;
            csvRows.push([line, `${summary.expense[type].count} ครั้ง`, `${summary.expense[type].amount.toLocaleString()} บาท`]); 
        }
        csvRows.push(['']); // เว้นบรรทัด
        
        // --- ส่วนสรุปยอด ---
        csvRows.push(['--- สรุปยอดสุทธิ ---']);
        const netAmount = summary.totalIncome - summary.totalExpense; 
        const netText = netAmount > 0 ? 'รายได้มากกว่ารายจ่าย' : (netAmount < 0 ? 'รายจ่ายมากกว่ารายได้' : 'รายได้เท่ากับรายจ่าย');
        let summaryLineText = `สรุป: ${netText} = ${Math.abs(netAmount).toLocaleString()} บาท`;
        if(netAmount === 0 && summary.totalIncome === 0 && summary.totalExpense === 0) {
            summaryLineText = `สรุป: ไม่มีรายการการเงินในช่วงนี้`;
        }
        csvRows.push([summaryLineText]); 
        csvRows.push([`ยอดเงินคงเหลือในบัญชี (ณ วันสิ้นสุด):`, `${totalBalance.toLocaleString()} บาท`]); 
        csvRows.push(['หมายเหตุ:', remark]); 
        csvRows.push(['']); // เว้นบรรทัด
        
// --- ส่วนรายละเอียดธุรกรรม ---
if (periodRecords.length > 0) {
    csvRows.push([`--- รายละเอียดธุรกรรม: ${title} ---`]);
    csvRows.push(['วันที่', 'เวลา', 'ประเภท', 'รายละเอียด', 'จำนวนเงิน']);
    periodRecords.forEach(record => {
        const d = new Date(record.dateTime);

        // วันที่แบบไทย: dd/mm/yyyy
        const date = d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });

        // เวลาแบบ hh.mm น. (เช่น 13.00 น.)
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        const time = `${hours}.${minutes} น.`;

        // จำนวนเงินคั่นหลักพัน
        const amount = record.amount.toLocaleString('th-TH');

        csvRows.push([date, time, record.type, record.description, amount]);
    });
}


        const csvContent = Papa.unparse(csvRows, { header: false }); 
        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
        const fileName = `สรุป_${currentAccount}_${periodName}_${new Date().getTime()}.csv`;
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(blob); 
        link.download = fileName; 
        link.click(); 
        URL.revokeObjectURL(link.href);
    }
    
    // --- Updated Summary Functions ---
    function summarizeToday() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อน"); return; }
        const startDate = new Date(new Date().setHours(0, 0, 0, 0));
        const endDate = new Date(new Date().setHours(23, 59, 59, 999));
        const summaryResult = generateSummaryData(startDate, endDate);
        if (!summaryResult) return;
        const remarkInput = prompt("กรุณากรอกหมายเหตุ (ถ้าไม่กรอกจะใช้ 'No comment'):", "No comment") || "No comment";
        summaryContext = {
            summaryResult, title: "สรุปข้อมูลของวันที่", dateString: new Date(startDate).toLocaleString('th-TH', { dateStyle: 'full' }),
            remark: remarkInput, transactionDaysInfo: null, periodName: 'วันนี้',
            showDetailsOnDisplay: true // แสดงรายละเอียดบนจอ
        };
        openSummaryOutputModal();
    }

    function summarizeByDayMonth() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อน"); return; }
        const dayMonthInput = document.getElementById('customDayMonth').value.trim();
        const selectedDate = parseDateInput(dayMonthInput);
        if (!selectedDate) { alert("กรุณากรอกวัน/เดือน/ปี ค.ศ. ในรูปแบบ วัน/เดือน/ปี (เช่น 10/11/2024)"); return; }
        const startDate = new Date(selectedDate.setHours(0, 0, 0, 0));
        const endDate = new Date(selectedDate.setHours(23, 59, 59, 999));
        const summaryResult = generateSummaryData(startDate, endDate);
        if (!summaryResult) return;
        const remarkInput = prompt("กรุณากรอกหมายเหตุ (ถ้าไม่กรอกจะใช้ 'No comment'):", "No comment") || "No comment";
        summaryContext = {
            summaryResult, title: "สรุปข้อมูลของวันที่", dateString: new Date(startDate).toLocaleString('th-TH', { dateStyle: 'full' }),
            remark: remarkInput, transactionDaysInfo: null, periodName: dayMonthInput.replace(/\//g, '-'),
            showDetailsOnDisplay: true // แสดงรายละเอียดบนจอ
        };
        openSummaryOutputModal();
    }
    
    // [ปรับปรุง] ฟังก์ชันนี้จะตั้งค่าให้ไม่แสดงรายละเอียดบนจอ
    function summarize() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อน"); return; }
        const startDate = parseDateInput(document.getElementById('startDate').value.trim()); const endDate = parseDateInput(document.getElementById('endDate').value.trim());
        if (!startDate || !endDate) { alert("กรุณากรอกวันที่ให้ครบถ้วนและถูกต้อง (วัน/เดือน/ปี)"); return; } if (startDate > endDate) { alert("วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด"); return; }
        endDate.setHours(23, 59, 59, 999);
        const summaryResult = generateSummaryData(startDate, endDate);
        if (!summaryResult) return;
        const daysDiff = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        const transactionDays = new Set(summaryResult.periodRecords.map(r => new Date(r.dateTime).toDateString()));
        const transactionDaysInfo = {
            totalDaysText: `จำนวน ${daysDiff} วัน`,
            activityText: `ทำธุรกรรม ${transactionDays.size} วัน, ไม่ได้ทำ ${daysDiff - transactionDays.size} วัน`
        };
        const remarkInput = prompt("กรุณากรอกหมายเหตุ (ถ้าไม่กรอกจะใช้ 'No comment'):", "No comment") || "No comment";
        summaryContext = {
            summaryResult, title: "สรุปข้อมูลช่วงวันที่", dateString: `${startDate.toLocaleDateString('th-TH')} ถึง ${endDate.toLocaleDateString('th-TH')}`,
            remark: remarkInput, transactionDaysInfo: transactionDaysInfo, periodName: `จาก${document.getElementById('startDate').value.trim().replace(/\//g, '-')}_ถึง${document.getElementById('endDate').value.trim().replace(/\//g, '-')}`,
            showDetailsOnDisplay: false // ไม่ต้องแสดงรายละเอียดบนจอ
        };
        openSummaryOutputModal();
    }
    
    // [ปรับปรุง] ฟังก์ชันนี้จะตั้งค่าให้ไม่แสดงรายละเอียดบนจอ
    function summarizeAll() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อน"); return; }
        const accountRecords = records.filter(r => r.account === currentAccount);
        if (accountRecords.length === 0) { alert("ไม่มีข้อมูลในบัญชีนี้ให้สรุป"); return; }
        const allDates = accountRecords.map(r => new Date(r.dateTime));
        const startDate = new Date(Math.min.apply(null, allDates)); const endDate = new Date(Math.max.apply(null, allDates));
        startDate.setHours(0, 0, 0, 0); endDate.setHours(23, 59, 59, 999);
        const summaryResult = generateSummaryData(startDate, endDate);
        if (!summaryResult) return;
        const daysDiff = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        const transactionDays = new Set(summaryResult.periodRecords.map(r => new Date(r.dateTime).toDateString()));
        const transactionDaysInfo = {
            totalDaysText: `รวมเป็นเวลา ${daysDiff} วัน`,
            activityText: `ทำธุรกรรม ${transactionDays.size} วัน, ไม่ได้ทำ ${daysDiff - transactionDays.size} วัน`
        };
        const remarkInput = prompt("กรุณากรอกหมายเหตุ (ถ้าไม่กรอกจะใช้ 'No comment'):", "No comment") || "No comment";
        summaryContext = {
            summaryResult, title: "สรุปข้อมูลทั้งหมดตั้งแต่", dateString: `${startDate.toLocaleDateString('th-TH')} ถึง ${endDate.toLocaleDateString('th-TH')}`,
            remark: remarkInput, transactionDaysInfo: transactionDaysInfo, periodName: 'ทั้งหมด',
            showDetailsOnDisplay: false // ไม่ต้องแสดงรายละเอียดบนจอ
        };
        openSummaryOutputModal();
    }

    // --- Modal Controls & File Handling ---
    function closeFormatModal() { document.getElementById('formatSelectionModal').style.display = 'none'; }
    function closeExportSingleAccountModal() { document.getElementById('exportSingleAccountModal').style.display = 'none'; }
    function saveToFile() { if (accounts.length === 0) { alert("ไม่มีบัญชีให้บันทึก"); return; } document.getElementById('formatSelectionModal').style.display = 'flex'; }
    
    // ***** START: CODE CORRECTION *****
    // This function was missing, causing the "บันทึกชั่วคราว" button to fail.
    // It calls the existing saveDataAndShowToast function to save data to localStorage.
    function saveToLocal() {
        saveDataAndShowToast('neutral'); // Using 'neutral' to show a generic success toast.
    }
    // ***** END: CODE CORRECTION *****

    function handleSaveAs(format) {
        closeFormatModal(); const formatLower = format.toLowerCase().trim(); const fileName = prompt("กรุณากรอกชื่อไฟล์สำหรับสำรองข้อมูล (ไม่ต้องใส่นามสกุล):", "backup_all"); if (!fileName) return;
        const now = new Date(); const dateTimeString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
        if (formatLower === 'json') {
            const fullFileName = `${fileName}_${dateTimeString}.json`; const data = { accounts, currentAccount, records, accountTypes: Array.from(accountTypes.entries()) };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fullFileName; a.click(); URL.revokeObjectURL(url);
            alert(`บันทึกข้อมูลทั้งหมดลงในไฟล์ "${fullFileName}" เรียบร้อยแล้ว`);
        } else if (formatLower === 'csv') {
            const fullFileName = `${fileName}_${dateTimeString}.csv`; let csvData = []; csvData.push(['###ALL_ACCOUNTS_BACKUP_CSV###']); csvData.push(['###ACCOUNTS_LIST###', ...accounts]); csvData.push(['###ACCOUNT_TYPES_START###']);
            for (const [accName, typesObj] of accountTypes.entries()) {
                initializeAccountTypes(accName); const currentTypes = accountTypes.get(accName);
                if (currentTypes.รายรับ && currentTypes.รายรับ.length > 0) csvData.push([accName, 'รายรับ', ...currentTypes.รายรับ]);
                if (currentTypes.รายจ่าย && currentTypes.รายจ่าย.length > 0) csvData.push([accName, 'รายจ่าย', ...currentTypes.รายจ่าย]);
            }
            csvData.push(['###ACCOUNT_TYPES_END###']); csvData.push(['###DATA_START###']); csvData.push(["วันที่", "เวลา", "ประเภท", "รายละเอียด", "จำนวนเงิน (บาท)", "บัญชี"]);
            const allSortedRecords = [...records].sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            allSortedRecords.forEach(record => {
                const dateTime = new Date(record.dateTime); const formattedDate = `${String(dateTime.getDate()).padStart(2, '0')}/${String(dateTime.getMonth() + 1).padStart(2, '0')}/${dateTime.getFullYear()}`; const formattedTime = `${String(dateTime.getHours()).padStart(2, '0')}.${String(dateTime.getMinutes()).padStart(2, '0')} น.`;
                csvData.push([formattedDate, formattedTime, record.type, record.description, record.amount, record.account]);
            });
            let csvContent = Papa.unparse(csvData, { header: false }); const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fullFileName; link.click(); URL.revokeObjectURL(link.href);
            alert(`บันทึกข้อมูลทั้งหมดลงในไฟล์ CSV "${fullFileName}" เรียบร้อยแล้ว`);
        }
    }
    function exportSelectedAccount() { if (!currentAccount) { alert("กรุณาเลือกบัญชีที่ต้องการส่งออกก่อน"); return; } document.getElementById('exportSingleAccountModal').style.display = 'flex'; }
    function handleExportSelectedAs(format) {
        closeExportSingleAccountModal(); if (!currentAccount) { alert("เกิดข้อผิดพลาด: ไม่พบบัญชีที่เลือก"); return; }
        const fileName = prompt(`กรุณากรอกชื่อไฟล์สำหรับบัญชี ${currentAccount} (ไม่ต้องใส่นามสกุล):`, currentAccount); if (!fileName) return;
        const now = new Date(); const dateTimeString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
        if (format === 'json') {
            const fullFileName = `${fileName}_${dateTimeString}.json`; const accountData = { accountName: currentAccount, records: records.filter(record => record.account === currentAccount), accountTypes: accountTypes.get(currentAccount) || { "รายรับ": [], "รายจ่าย": [] } };
            const blob = new Blob([JSON.stringify(accountData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fullFileName; a.click(); URL.revokeObjectURL(url);
            alert(`ส่งออกบัญชี "${currentAccount}" เป็น JSON เรียบร้อย\n\nไฟล์: ${fullFileName}`);
        } else if (format === 'csv') {
            const fullFileName = `${fileName}_${dateTimeString}.csv`; initializeAccountTypes(currentAccount); const accountCurrentTypes = accountTypes.get(currentAccount); let excelData = [];
            excelData.push([`ชื่อบัญชี: ${currentAccount}`]); excelData.push(['###ACCOUNT_TYPES###']); excelData.push(['รายรับ', ...(accountCurrentTypes['รายรับ'] || [])]); excelData.push(['รายจ่าย', ...(accountCurrentTypes['รายจ่าย'] || [])]); excelData.push(['###DATA_START###']); excelData.push(["วันที่", "เวลา", "ประเภท", "รายละเอียด", "จำนวนเงิน (บาท)"]);
            const filteredRecords = records.filter(record => record.account === currentAccount).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            filteredRecords.forEach(record => {
                const dateTime = new Date(record.dateTime); const formattedDate = `${String(dateTime.getDate()).padStart(2, '0')}/${String(dateTime.getMonth() + 1).padStart(2, '0')}/${dateTime.getFullYear()}`; const formattedTime = `${String(dateTime.getHours()).padStart(2, '0')}.${String(dateTime.getMinutes()).padStart(2, '0')} น.`;
                excelData.push([formattedDate, formattedTime, record.type, record.description, record.amount]);
            });
            let csvContent = Papa.unparse(excelData, { header: false }); const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fullFileName; link.click(); document.body.removeChild(link);
            alert(`ส่งออกบัญชี "${currentAccount}" เป็น CSV เรียบร้อย\n\nไฟล์: ${fullFileName}`);
        }
    }
    function loadFromFile(event) {
        const file = event.target.files[0]; if (!file) { return; } const reader = new FileReader(); const fileName = file.name.toLowerCase();
        if (fileName.endsWith('.csv')) { reader.onload = (e) => loadFromCsv(e.target.result); reader.readAsText(file, 'UTF-8');
        } else if (fileName.endsWith('.json')) {
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.accounts && Array.isArray(data.accounts)) { // All accounts backup
                        if(confirm("ไฟล์นี้เป็นไฟล์สำรองข้อมูล JSON ทั้งหมด ต้องการโหลดข้อมูลทั้งหมดทับของเดิมหรือไม่?")) {
                            accounts = data.accounts; records = data.records; accountTypes = new Map(data.accountTypes); currentAccount = data.currentAccount;
                            updateAccountSelect(); if (currentAccount) document.getElementById('accountSelect').value = currentAccount; changeAccount(); alert("โหลดข้อมูลทั้งหมดจาก JSON สำเร็จ");
                        }
                    } else if (data.accountName) { // Single account
                        const confirmMsg = `ไฟล์นี้เป็นข้อมูลของบัญชี "${data.accountName}"\n\nกด OK เพื่อ "แทนที่" ข้อมูลทั้งหมดของบัญชีนี้\nกด Cancel เพื่อยกเลิก`;
                        if (confirm(confirmMsg)) {
                            if (!accounts.includes(data.accountName)) accounts.push(data.accountName); records = records.filter(r => r.account !== data.accountName); records.push(...(data.records || []));
                            accountTypes.set(data.accountName, data.accountTypes || { "รายรับ": [], "รายจ่าย": [] }); currentAccount = data.accountName;
                            updateAccountSelect(); document.getElementById('accountSelect').value = currentAccount; changeAccount(); saveToLocal(); alert(`แทนที่ข้อมูลบัญชี "${data.accountName}" สำเร็จ`);
                        }
                    } else { throw new Error("รูปแบบไฟล์ JSON ไม่ถูกต้อง"); }
                    updateMultiAccountSelector();
                } catch (error) { alert("ไฟล์ JSON ไม่ถูกต้องหรือเสียหาย: " + error.message); }
            };
            reader.readAsText(file);
        } else { alert("กรุณาเลือกไฟล์ .json หรือ .csv เท่านั้น"); }
        reader.onerror = () => alert("เกิดข้อผิดพลาดในการอ่านไฟล์"); event.target.value = '';
    }
    function loadFromCsv(csvText) {
        let isFullBackup = false; let isFirstRow = true; let newFullAccounts = []; let newFullRecords = []; let newFullAccountTypes = new Map(); let importAccountName = ''; let importedTypes = { "รายรับ": [], "รายจ่าย": [] }; let newRecords = []; let inTypesSection = false; let inDataSection = false; let isDataHeaderRow = true;
        Papa.parse(csvText, {
            skipEmptyLines: true,
            step: function(results) {
                const rowData = results.data; const firstCell = rowData[0] || '';
                if (isFirstRow) { if (firstCell === '###ALL_ACCOUNTS_BACKUP_CSV###') { isFullBackup = true; } isFirstRow = false; if(isFullBackup) return; }
                if (isFullBackup) {
                    if (firstCell.startsWith('###')) {
                        if (firstCell === '###ACCOUNTS_LIST###') newFullAccounts = rowData.slice(1).filter(Boolean); else if (firstCell === '###ACCOUNT_TYPES_START###') inTypesSection = true; else if (firstCell === '###ACCOUNT_TYPES_END###') inTypesSection = false; else if (firstCell === '###DATA_START###') { inDataSection = true; isDataHeaderRow = true; } return;
                    }
                    if (inTypesSection) {
                        const accName = rowData[0]; const category = rowData[1]; const typesList = rowData.slice(2).filter(Boolean); if (!newFullAccountTypes.has(accName)) newFullAccountTypes.set(accName, { "รายรับ": [], "รายจ่าย": [] }); if ((category === 'รายรับ' || category === 'รายจ่าย') && typesList.length > 0) newFullAccountTypes.get(accName)[category].push(...typesList);
                    } else if (inDataSection) {
                        if (isDataHeaderRow) { isDataHeaderRow = false; return; } const [dateStr, timeStr, type, description, amountStr, recordAccount] = rowData;
                        try {
                            if (!dateStr || !timeStr || !type || !amountStr || !recordAccount) throw new Error("ข้อมูลไม่ครบถ้วน"); const [day, month, year] = dateStr.trim().split('/'); if(!day || !month || !year) throw new Error("รูปแบบวันที่ไม่ถูกต้อง (DD/MM/YYYY)");
                            const formattedDate = `${year.trim()}-${String(month.trim()).padStart(2, '0')}-${String(day.trim()).padStart(2, '0')}`; const formattedTime = timeStr.trim().replace(' น.', '').replace('.', ':'); const dateTime = `${formattedDate} ${formattedTime}`; const amount = parseFloat(String(amountStr).replace(/,/g, ''));
                            if (isNaN(new Date(dateTime).getTime())) throw new Error(`วันที่เวลาไม่ถูกต้อง: ${dateTime}`); if (isNaN(amount)) throw new Error(`จำนวนเงินไม่ถูกต้อง: ${amountStr}`);
                            newFullRecords.push({ dateTime, type: type.trim(), description: (description || '').trim(), amount, account: recordAccount.trim() });
                        } catch (e) { console.warn(`ข้ามแถวข้อมูลที่มีปัญหา (Full Backup): ${e.message}`, rowData); }
                    }
                } else {
                    if (firstCell.startsWith('###')) { if (firstCell === '###ACCOUNT_TYPES###') inTypesSection = true; else if (firstCell === '###DATA_START###') { inTypesSection = false; inDataSection = true; isDataHeaderRow = true; } return; }
                    if (inTypesSection) { if (firstCell === 'รายรับ') importedTypes['รายรับ'] = rowData.slice(1).filter(Boolean); else if (firstCell === 'รายจ่าย') importedTypes['รายจ่าย'] = rowData.slice(1).filter(Boolean);
                    } else if (inDataSection) {
                        if (isDataHeaderRow) { isDataHeaderRow = false; return; } const [dateStr, timeStr, type, description, amountStr] = rowData;
                        try {
                             if (!dateStr || !timeStr || !type || !amountStr) throw new Error("ข้อมูลไม่ครบถ้วน"); const [day, month, year] = dateStr.trim().split('/'); if(!day || !month || !year) throw new Error("รูปแบบวันที่ไม่ถูกต้อง");
                             const formattedDate = `${year.trim()}-${String(month.trim()).padStart(2, '0')}-${String(day.trim()).padStart(2, '0')}`; const formattedTime = timeStr.trim().replace(' น.', '').replace('.', ':'); const dateTime = `${formattedDate} ${formattedTime}`; const amount = parseFloat(String(amountStr).replace(/,/g, ''));
                             if (isNaN(new Date(dateTime).getTime())) throw new Error(`วันที่เวลาไม่ถูกต้อง`); if (isNaN(amount)) throw new Error(`จำนวนเงินไม่ถูกต้อง`);
                             newRecords.push({ dateTime, type: type.trim(), description: (description || '').trim(), amount, account: importAccountName });
                        } catch (e) { console.warn(`ข้ามแถวข้อมูลที่มีปัญหา (Single Account): ${e.message}`, rowData); }
                    } else { if (firstCell.startsWith('ชื่อบัญชี:')) importAccountName = firstCell.split(':')[1].trim(); }
                }
            },
            complete: function() {
                if (isFullBackup) {
                    if (confirm(`ไฟล์นี้เป็นไฟล์สำรองข้อมูล CSV ทั้งหมด (${newFullRecords.length} รายการ) ต้องการโหลดข้อมูลทั้งหมดทับของเดิมหรือไม่?`)) {
                        accounts = newFullAccounts; records = newFullRecords; accountTypes = newFullAccountTypes; currentAccount = accounts.includes(currentAccount) ? currentAccount : (accounts[0] || null);
                        updateAccountSelect(); if (currentAccount) document.getElementById('accountSelect').value = currentAccount; changeAccount(); saveToLocal(); alert("โหลดข้อมูลทั้งหมดจาก CSV สำเร็จ!");
                    }
                } else {
                    if (!importAccountName) { alert('ไฟล์ CSV ไม่ถูกต้อง: ไม่พบชื่อบัญชีในไฟล์'); return; }
                    const confirmMsg = `คุณต้องการ "แทนที่" ข้อมูลทั้งหมดในบัญชี "${importAccountName}" ด้วยข้อมูล ${newRecords.length} รายการจากไฟล์นี้ใช่หรือไม่?\n\nคำเตือน: ข้อมูลเดิมในบัญชีนี้จะถูกลบทั้งหมด!`;
                    if (confirm(confirmMsg)) {
                        if (!accounts.includes(importAccountName)) accounts.push(importAccountName); records = records.filter(r => r.account !== importAccountName); records.push(...newRecords); accountTypes.set(importAccountName, importedTypes);
                        currentAccount = importAccountName; updateAccountSelect(); document.getElementById('accountSelect').value = currentAccount; changeAccount(); saveToLocal(); alert(`แทนที่ข้อมูลบัญชี "${importAccountName}" สำเร็จ!`);
                    }
                }
            },
            error: function(err) { alert('เกิดข้อผิดพลาดในการประมวลผลไฟล์ CSV: ' + err.message); }
        });
    }

    function hideInstallPrompt() { const installGuide = document.getElementById('install-guide'); if (installGuide) { installGuide.style.display = 'none'; } }
    window.addEventListener('appinstalled', () => { console.log('App was installed.'); hideInstallPrompt(); localStorage.setItem('pwa_installed', 'true'); });
    window.onload = function () { document.getElementById('detailsSection').style.display = 'none'; loadFromLocal(); toggleSection('account-section'); window.addEventListener('click', (event) => { const modal = document.getElementById('summaryModal'); if (event.target == modal) { closeSummaryModal(); } }); if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || localStorage.getItem('pwa_installed') === 'true') { hideInstallPrompt(); } };
</script>

<!-- Script สำหรับลงทะเบียน Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>

</body>
</html>
